version: '3.8'
services:
  # PostgreSQL MDM Database
  postgres-mdm:
    image: postgres:13
    container_name: postgres-mdm
    environment:
      POSTGRES_DB: mdm_hub
      POSTGRES_USER: mdm_user
      POSTGRES_PASSWORD: mdm_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../database/init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mdm_user -d mdm_hub"]
      interval: 30s
      timeout: 10s
      retries: 3

  # OpenMetadata
  openmetadata-server:
    image: openmetadata/server:1.2.0
    container_name: openmetadata-server
    ports:
      - "8585:8585"
    environment:
      DB_HOST: postgres-mdm
      DB_USER: mdm_user
      DB_PASSWORD: mdm_password
      DB_NAME: mdm_hub
      OPENMETADATA_ADMIN_EMAIL: admin@logistics-mdm.com
      OPENMETADATA_ADMIN_PASSWORD: admin123
    depends_on:
      postgres-mdm:
        condition: service_healthy
    volumes:
      - ../openmetadata/config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data: